#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SSH_HOSTS_BIN="${SSH_HOSTS_BIN:-$SCRIPT_DIR/ssh-hosts}"
TMUX_SSH_OPEN_BIN="${TMUX_SSH_OPEN_BIN:-$SCRIPT_DIR/tmux-ssh-open}"

if ! command -v fzf &>/dev/null; then
    tmux display-message "tmux-ssh-fzf: fzf not found"
    exit 1
fi

if [[ ! -x "$SSH_HOSTS_BIN" ]]; then
    tmux display-message "tmux-ssh-fzf: ssh-hosts helper not found"
    exit 1
fi

mapfile -t selection < <(
    "$SSH_HOSTS_BIN" | fzf --multi --prompt "SSH> " \
        --preview 'ssh -G {} 2>/dev/null | awk "tolower(\$1) ~ /^(hostname|user|port|proxyjump|identityfile)$/{print}"' \
        --preview-window 'right:60%:wrap'
)

if ((${#selection[@]} == 0)); then
    exit 0
fi

if [[ ! -x "$TMUX_SSH_OPEN_BIN" ]]; then
    tmux display-message "tmux-ssh-fzf: tmux-ssh-open helper not found"
    exit 1
fi

"$TMUX_SSH_OPEN_BIN" "${selection[@]}"
